---
- name: Install Logstash
  hosts: elastic-logstash
  become: true
  vars_files:
    - vars/variables.yml
  tasks:
    - include_tasks: common_task_install_elk_repo.yml

    - name: Configure systcl vm.max_map_count=262144 on container hosts
      sysctl:
        name: "vm.max_map_count"
        value: "262144"
        state: "present"
        reload: "yes"
      delegate_to: "{{ physical_host }}"
      tags:
        - sysctl

    - name: logstash datapath bind mount
      lxc_container:
        name: "{{ inventory_hostname }}"
        container_command: |
          [[ ! -d "/var/lib/logstash" ]] && mkdir -p "/var/lib/logstash"
        container_config:
          - "lxc.mount.entry=/openstack/{{ inventory_hostname }} var/lib/logstash none bind 0 0"
      delegate_to: "{{ physical_host }}"
      when:
        - physical_host != inventory_hostname
        - container_tech | default('lxc') == 'lxc'

    - name: Ensure Java is installed
      apt:
        name: openjdk-8-jre
        state: present
        install_recommends: yes
        update_cache: yes

    - name: Ensure Logstash is installed.
      apt:
        name: logstash
        state: present
        update_cache: yes

    - name: Drop Logstash conf for beats input
      template:
        src: templates/02-beats-input.conf.j2
        dest: /etc/logstash/conf.d/02-beats-input.conf

    - name: Drop Logstash conf for beats input
      template:
        src: templates/10-syslog-filter.conf.j2
        dest: /etc/logstash/conf.d/10-syslog-filter.conf

    - name: Drop Logstash conf for beats output
      template:
        src: templates/30-elasticsearch-output.conf.j2
        dest: /etc/logstash/conf.d/30-elasticsearch-output.conf

    - name: Ensure logstash ownership
      file:
        path: /var/lib/logstash
        owner: logstash
        group: logstash
        recurse: true

    - name: Load logstash config
      command: "/usr/share/logstash/bin/logstash -t --path.settings /etc/logstash"
      register: conf_success
      become: yes
      become_user: logstash

    - name: Print config output
      debug: var=conf_success

    - name: Enable and restart logstash
      systemd:
        name: "logstash"
        enabled: true
        state: restarted
